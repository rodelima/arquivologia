/*!
 * jQCloud 2.0.1
 * Copyright 2011 Luca Ongaro (http://www.lucaongaro.eu)
 * Copyright 2013 Daniel White (http://www.developerdan.com)
 * Copyright 2014 Damien "Mistic" Sorel (http://www.strangeplanet.fr)
 * Licensed under MIT (http://opensource.org/licenses/MIT)
 */
(function(n){"use strict";function i(n,t,i){var r={pid:null,last:0};return function(){function f(){return r.last=(new Date).getTime(),n.apply(i||o,Array.prototype.slice.call(e))}var u=(new Date).getTime()-r.last,e=arguments,o=this;if(u>t)return f();clearTimeout(r.pid);r.pid=setTimeout(f,t-u)}}var t=function(t,i,r){this.$element=n(t);this.word_array=i||[];this.options=r;this.sizeGenerator=null;this.colorGenerator=null;this.data={placed_words:[],timeouts:{},namespace:null,step:null,angle:null,aspect_ratio:null,max_weight:null,min_weight:null,sizes:[],colors:[]};this.initialize()};t.DEFAULTS={width:100,height:100,center:{x:.5,y:.5},steps:10,delay:null,shape:"elliptic",classPattern:"w{n}",encodeURI:!0,removeOverflowing:!0,afterCloudRender:null,autoResize:!1,colors:null,fontSize:null,template:null};t.prototype={initialize:function(){var r,f,u,e;if(this.options.width?this.$element.width(this.options.width):this.options.width=this.$element.width(),this.options.height?this.$element.height(this.options.height):this.options.height=this.$element.height(),this.options=n.extend(!0,{},t.DEFAULTS,this.options),this.options.delay===null&&(this.options.delay=this.word_array.length>50?10:0),this.options.center.x>1&&(this.options.center.x=this.options.center.x/this.options.width,this.options.center.y=this.options.center.y/this.options.height),typeof this.options.colors=="function")this.colorGenerator=this.options.colors;else if(n.isArray(this.options.colors)&&(r=this.options.colors.length,r>0)){if(r<this.options.steps)for(f=r;f<this.options.steps;f++)this.options.colors[f]=this.options.colors[r-1];this.colorGenerator=function(n){return this.options.colors[this.options.steps-n]}}if(typeof this.options.fontSize=="function")this.sizeGenerator=this.options.fontSize;else if(n.isPlainObject(this.options.fontSize))this.sizeGenerator=function(n,t,i){var u=n*this.options.fontSize.from,r=n*this.options.fontSize.to;return Math.round(r+(u-r)*1/(this.options.steps-1)*(i-1))+"px"};else if(n.isArray(this.options.fontSize)&&(u=this.options.fontSize.length,u>0)){if(u<this.options.steps)for(e=u;e<this.options.steps;e++)this.options.fontSize[e]=this.options.fontSize[u-1];this.sizeGenerator=function(n,t,i){return this.options.fontSize[this.options.steps-i]}}if(this.data.angle=Math.random()*6.28,this.data.step=this.options.shape==="rectangular"?18:2,this.data.aspect_ratio=this.options.width/this.options.height,this.clearTimeouts(),this.data.namespace=(this.$element.attr("id")||Math.floor(Math.random()*1e6).toString(36))+"_word_",this.$element.addClass("jqcloud"),this.$element.css("position")==="static"&&this.$element.css("position","relative"),this.createTimeout(n.proxy(this.drawWordCloud,this),10),this.options.autoResize)n(window).on("resize",i(function(){var n={width:this.$element.width(),height:this.$element.height()};(n.width!=this.options.width||n.height!=this.options.height)&&(this.options.width=n.width,this.options.height=n.height,this.data.aspect_ratio=this.options.width/this.options.height,this.update(this.word_array))},50,this))},createTimeout:function(t,i){var r=setTimeout(n.proxy(function(){delete this.data.timeouts[r];t()},this),i);this.data.timeouts[r]=!0},clearTimeouts:function(){n.each(this.data.timeouts,function(n){clearTimeout(n)});this.data.timeouts={}},overlapping:function(n,t){return Math.abs(2*n.left+n.width-2*t.left-t.width)<n.width+t.width&&Math.abs(2*n.top+n.height-2*t.top-t.height)<n.height+t.height?!0:!1},hitTest:function(n){for(var t=0,i=this.data.placed_words.length;t<i;t++)if(this.overlapping(n,this.data.placed_words[t]))return!0;return!1},drawWordCloud:function(){var n,t;if(this.$element.children('[id^="'+this.data.namespace+'"]').remove(),this.word_array.length!==0){for(n=0,t=this.word_array.length;n<t;n++)this.word_array[n].weight=parseFloat(this.word_array[n].weight,10);if(this.word_array.sort(function(n,t){return t.weight-n.weight}),this.data.max_weight=this.word_array[0].weight,this.data.min_weight=this.word_array[this.word_array.length-1].weight,this.data.colors=[],this.colorGenerator)for(n=0;n<this.options.steps;n++)this.data.colors.push(this.colorGenerator(n+1));if(this.data.sizes=[],this.sizeGenerator)for(n=0;n<this.options.steps;n++)this.data.sizes.push(this.sizeGenerator(this.options.width,this.options.height,n+1));if(this.options.delay>0)this.drawOneWordDelayed();else{for(n=0,t=this.word_array.length;n<t;n++)this.drawOneWord(n,this.word_array[n]);typeof this.options.afterCloudRender=="function"&&this.options.afterCloudRender.call(this.$element)}}},drawOneWord:function(t,i){var l=this.data.namespace+t,a="#"+l,s=this.data.angle,h=0,c=0,e=0,o=Math.floor(this.options.steps/2),u,r,f;if(i.attr=n.extend({},i.html,{id:l}),this.data.max_weight!=this.data.min_weight&&(o=Math.round((i.weight-this.data.min_weight)*1*(this.options.steps-1)/(this.data.max_weight-this.data.min_weight))+1),u=n("<span>").attr(i.attr),this.options.classPattern&&u.addClass(this.options.classPattern.replace("{n}",o)),this.data.colors.length&&u.css("color",this.data.colors[o-1]),this.data.sizes.length&&u.css("font-size",this.data.sizes[o-1]),this.options.template?u.html(this.options.template(i)):i.link?(typeof i.link=="string"&&(i.link={href:i.link}),this.options.encodeURI&&(i.link.href=encodeURI(i.link.href).replace(/'/g,"%27")),u.append(n("<a>").attr(i.link).text(i.text))):u.text(i.text),i.handlers)u.on(i.handlers);for(this.$element.append(u),r={width:u.width(),height:u.height()},r.left=this.options.center.x*this.options.width-r.width/2,r.top=this.options.center.y*this.options.height-r.height/2,f=u[0].style,f.position="absolute",f.left=r.left+"px",f.top=r.top+"px";this.hitTest(r);){if(this.options.shape==="rectangular"){c++;c*this.data.step>(1+Math.floor(e/2))*this.data.step*(e%4%2==0?1:this.data.aspect_ratio)&&(c=0,e++);switch(e%4){case 1:r.left+=this.data.step*this.data.aspect_ratio+Math.random()*2;break;case 2:r.top-=this.data.step+Math.random()*2;break;case 3:r.left-=this.data.step*this.data.aspect_ratio+Math.random()*2;break;case 0:r.top+=this.data.step+Math.random()*2}}else h+=this.data.step,s+=(t%2==0?1:-1)*this.data.step,r.left=this.options.center.x*this.options.width-r.width/2+h*Math.cos(s)*this.data.aspect_ratio,r.top=this.options.center.y*this.options.height+h*Math.sin(s)-r.height/2;f.left=r.left+"px";f.top=r.top+"px"}if(this.options.removeOverflowing&&(r.left<0||r.top<0||r.left+r.width>this.options.width||r.top+r.height>this.options.height)){u.remove();return}this.data.placed_words.push(r);typeof i.afterWordRender=="function"&&i.afterWordRender.call(u)},drawOneWordDelayed:function(t){if(t=t||0,!this.$element.is(":visible")){this.createTimeout(n.proxy(function(){this.drawOneWordDelayed(t)},this),10);return}t<this.word_array.length?(this.drawOneWord(t,this.word_array[t]),this.createTimeout(n.proxy(function(){this.drawOneWordDelayed(t+1)},this),this.options.delay)):typeof this.options.afterCloudRender=="function"&&this.options.afterCloudRender.call(this.$element)},destroy:function(){this.clearTimeouts();this.$element.removeClass("jqcloud");this.$element.removeData("jqcloud");this.$element.children('[id^="'+this.namespace+'"]').remove()},update:function(n){this.word_array=n;this.data.placed_words=[];this.clearTimeouts();this.drawWordCloud()}};n.fn.jQCloud=function(i,r){var u=arguments;return this.each(function(){var e=n(this),f=e.data("jqcloud"),o;(f||i!=="destroy")&&(f?typeof i=="string"&&f[i].apply(f,Array.prototype.slice.call(u,1)):(o=typeof r=="object"?r:{},e.data("jqcloud",f=new t(this,i,o))))})};n.fn.jQCloud.defaults={set:function(i){n.extend(!0,t.DEFAULTS,i)},get:function(i){var r=t.DEFAULTS;return i&&(r=r[i]),n.extend(!0,{},r)}}})(jQuery);